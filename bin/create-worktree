#!/bin/bash
#
# create-worktree - Create a git worktree for a feature branch
#
# Usage: create-worktree [OPTIONS] BRANCH_TYPE BRANCH_NAME WORKTREE_PATH
#
# Options:
#   -r, --repo-root DIR      Repository root (default: find from cwd)
#   -u, --upstream BRANCH    Upstream branch to base from (default: upstream/dev)
#   -i, --issue NUMBER       GitHub issue number to link
#   -s, --settings FILE      Claude settings file to symlink
#   -d, --description TEXT   Feature description
#   -q, --quiet              Suppress progress messages
#   -h, --help               Show this help
#
# Example:
#   create-worktree FEATURE my-feature ~/src/crewcapableai/FEATURE-my-feature -i 123

set -euo pipefail

# Defaults
REPO_ROOT=""
UPSTREAM_BRANCH="upstream/dev"
ISSUE_NUMBER=""
SETTINGS_FILE=""
DESCRIPTION=""
QUIET=false

die() {
    echo "ERROR: $*" >&2
    exit 1
}

info() {
    $QUIET || echo "$*" >&2
}

usage() {
    sed -n '3,16p' "$0" | sed 's/^# //' | sed 's/^#//'
    exit 0
}

# Parse options
while [[ $# -gt 0 ]]; do
    case $1 in
        -r|--repo-root)
            REPO_ROOT="$2"
            shift 2
            ;;
        -u|--upstream)
            UPSTREAM_BRANCH="$2"
            shift 2
            ;;
        -i|--issue)
            ISSUE_NUMBER="$2"
            shift 2
            ;;
        -s|--settings)
            SETTINGS_FILE="$2"
            shift 2
            ;;
        -d|--description)
            DESCRIPTION="$2"
            shift 2
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        -*)
            die "Unknown option: $1"
            ;;
        *)
            break
            ;;
    esac
done

# Positional arguments
[[ $# -ge 3 ]] || die "Usage: create-worktree BRANCH_TYPE BRANCH_NAME WORKTREE_PATH"

BRANCH_TYPE="$1"
BRANCH_NAME="$2"
WORKTREE_PATH="$3"

# Normalize branch type to uppercase
BRANCH_TYPE="${BRANCH_TYPE^^}"

# Build full branch name
FULL_BRANCH="${BRANCH_TYPE}/${BRANCH_NAME}"

# Find repo root if not specified
if [[ -z "$REPO_ROOT" ]]; then
    REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || die "Not in a git repository"
fi

# Validate repo root (check if git recognizes it)
git -C "$REPO_ROOT" rev-parse --git-dir &>/dev/null || die "Not a git repository: $REPO_ROOT"

# Check if worktree already exists
[[ ! -d "$WORKTREE_PATH" ]] || die "Worktree already exists: $WORKTREE_PATH"

# Ensure parent directory exists
PARENT_DIR=$(dirname "$WORKTREE_PATH")
mkdir -p "$PARENT_DIR"

# Fetch upstream
info "Fetching upstream..."
cd "$REPO_ROOT"
if ! git fetch upstream 2>/dev/null; then
    info "  upstream not found, trying origin..."
    git fetch origin 2>/dev/null || die "Failed to fetch from remote"
    UPSTREAM_BRANCH="${UPSTREAM_BRANCH/upstream/origin}"
fi

# Check if branch already exists
if git show-ref --verify --quiet "refs/heads/$FULL_BRANCH" 2>/dev/null; then
    info "Creating worktree for existing branch $FULL_BRANCH..."
    git worktree add "$WORKTREE_PATH" "$FULL_BRANCH" || die "Failed to create worktree"
else
    info "Creating worktree with new branch $FULL_BRANCH from $UPSTREAM_BRANCH..."
    git worktree add -b "$FULL_BRANCH" "$WORKTREE_PATH" "$UPSTREAM_BRANCH" || die "Failed to create worktree"
fi

# Verify worktree was created
[[ -d "$WORKTREE_PATH" ]] || die "Worktree creation failed silently"

cd "$WORKTREE_PATH"

# Install pre-commit hooks
info "Installing pre-commit hooks..."
if command -v pre-commit &>/dev/null; then
    pre-commit install 2>/dev/null || info "  Warning: pre-commit install failed"
else
    info "  Warning: pre-commit not found, skipping hook installation"
fi

# Setup Claude settings symlink
if [[ -n "$SETTINGS_FILE" && -f "$SETTINGS_FILE" ]]; then
    info "Setting up Claude settings..."
    mkdir -p "$WORKTREE_PATH/.claude"
    ln -sf "$SETTINGS_FILE" "$WORKTREE_PATH/.claude/settings.local.json"
fi

# Write issue link
if [[ -n "$ISSUE_NUMBER" ]]; then
    info "Linking to issue #$ISSUE_NUMBER..."
    echo "$ISSUE_NUMBER" > "$WORKTREE_PATH/.issue"
fi

# Write description
if [[ -n "$DESCRIPTION" ]]; then
    echo "$DESCRIPTION" > "$WORKTREE_PATH/.feature-description"
fi

info "âœ¨ Created $FULL_BRANCH at $WORKTREE_PATH"

# Output path for scripting
echo "$WORKTREE_PATH"
